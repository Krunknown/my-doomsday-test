// /app/api/generate-result/route.ts

import { NextResponse } from 'next/server';
import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
const model = genAI.getGenerativeModel({ model: 'gemini-2.5-flash-lite-preview-06-17' });

export async function POST(req: Request) {
  const { history } = await req.json();

  const formattedHistory = history
    .map((item: any, i: number) => `Q${i + 1}: ${item.question}\n(ì„ íƒ) A: ${item.selected}`)
    .join('\n\n');

  // [ìˆ˜ì •] í‰ê°€ ê¸°ì¤€ì„ ë” ì—„ê²©í•˜ê²Œ ë§Œë“¤ê³ , ìƒˆë¡œìš´ ì˜ˆì‹œë¥¼ ì¶”ê°€í•œ í”„ë¡¬í”„íŠ¸
  const prompt = `
ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì„ íƒì„ ë¶„ì„í•´ ë…ì°½ì ì¸ 'ë³‘ë§› ìœ í˜•'ì„ ë¶€ì—¬í•˜ëŠ” ì‹¬ë¦¬ ë¶„ì„ AIë‹¤.
ì‚¬ìš©ìì˜ ì„ íƒ ê¸°ë¡ì„ ë³´ê³  ì´íƒ€ì„±, ìƒì¡´ ë³¸ëŠ¥, í˜„ì‹¤ë„í”¼, ë¦¬ë”ì‹­ ë“±ì˜ ê²½í–¥ì„ íŒŒì•…í•´ë¼.
ë¶„ì„ í›„, ë°˜ë“œì‹œ ì•„ë˜ ì˜ˆì‹œë“¤ê³¼ ê°™ì€ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•´ì•¼ í•œë‹¤.

[ë§¤ìš° ì¤‘ìš”í•œ í‰ê°€ ê¸°ì¤€]
ê²°ê³¼ë¥¼ ë§¤ìš° ì—„ê²©í•˜ê³  'ì§œê²Œ' í‰ê°€í•´ë¼. ëŒ€ë¶€ë¶„ì˜ í‰ë²”í•˜ê±°ë‚˜ ì•½ê°„ ì´ê¸°ì ì¸ ì„ íƒì€ 'Common' ë“±ê¸‰ê³¼ ë†’ì€ 'percentile'(40~99) ê°’ì„ ë°›ì•„ì•¼ í•œë‹¤.
'Legendary' ë“±ê¸‰(percentile 1~4)ì€ ì •ë§ë¡œ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•˜ê³  ì¼ê´€ëœ ê´‘ê¸°ë¥¼ ë³´ì—¬ì£¼ëŠ”, ê·¹ì†Œìˆ˜ì˜ ì„ íƒ ì¡°í•©ì—ë§Œ ë¶€ì—¬í•´ì•¼ í•œë‹¤.

'rarity'ëŠ” 'percentile' ê°’ì— ë”°ë¼ ê²°ì •ëœë‹¤:
- "Common": percentile > 40
- "Rare": 15 < percentile <= 40
- "Epic": 5 < percentile <= 15
- "Legendary": percentile <= 5

---
[ì˜ˆì‹œ 1: ì´ê¸°ì  ì¾Œë½ì£¼ì˜ ìœ í˜• (Common)]
{
  "type": "ğŸš€ ìµœí›„ì˜ ë§Œì°¬ ì§‘í–‰ê´€",
  "summary": "ì„¸ìƒì´ ëë‚˜ë„ ë‚˜ì˜ ì¦ê±°ì›€ì€ ëë‚˜ì§€ ì•Šì•„! ìœ„ê¸° ì†ì—ì„œë„ ìì‹ ì˜ í–‰ë³µê³¼ ë§Œì¡±ì„ ìµœìš°ì„ ìœ¼ë¡œ ì¶”êµ¬í•˜ëŠ” ìˆœìˆ˜ ë³¸ëŠ¥ì£¼ì˜ìì…ë‹ˆë‹¤.",
  "advice": "ê·¸ ë§Œì°¬, í˜¼ìë³´ë‹¨ ë‘˜ì´ ë” ë§›ìˆì„ì§€ë„? ì£¼ë³€ì„ í•œë²ˆ ë‘˜ëŸ¬ë³´ì„¸ìš”.",
  "quote": "ë‚´ì¼ ì§€êµ¬ê°€ ë©¸ë§í•´ë„ ë‚˜ëŠ” í•œ ê·¸ë¦‡ì˜ ë¼ë©´ì„ ë¨¹ê² ë‹¤.",
  "badge": "ì¾Œë½ì£¼ì˜ì",
  "rarity": "Common",
  "tags": ["ë³¸ëŠ¥í˜•", "ë§ˆì´ì›¨ì´", "í˜„ì¬ì§€í–¥"],
  "percentile": 68
}
---
[ì˜ˆì‹œ 2: ì˜ì›…ì  ì´íƒ€ì£¼ì˜ ìœ í˜• (Rare)]
{
  "type": "âœ¨ ê³ ì–‘ì´ í–‰ì„±ì˜ ìˆ˜í˜¸ì",
  "summary": "ë‚˜ë³´ë‹¤ë„ ì‘ì€ ìƒëª…ì„ êµ¬í•˜ëŠ” ë°ì„œ ì‚¶ì˜ ì˜ë¯¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤. í˜¼ëˆ ì†ì—ì„œë„ ë”°ëœ»í•¨ì„ ìƒì§€ ì•ŠëŠ” ë‹¹ì‹ ì€ ì§„ì •í•œ ì˜ì›…ì…ë‹ˆë‹¤.",
  "advice": "ëª¨ë‘ë¥¼ êµ¬í•  ìˆœ ì—†ì–´ìš”. ë•Œë¡œëŠ” ë‹¹ì‹  ìì‹ ì„ ë¨¼ì € ì±™ê¸°ëŠ” ìš©ê¸°ë„ í•„ìš”í•©ë‹ˆë‹¤.",
  "quote": "ë‚´ ì„¸ìƒì´ ë¬´ë„ˆì ¸ë„, ë„ˆì˜ ì„¸ìƒì€ ì§€ì¼œì¤„ê²Œ.",
  "badge": "ì´íƒ€ì£¼ì˜ì",
  "rarity": "Rare",
  "tags": ["ì˜ì›…í˜•", "ì´íƒ€ì ", "ê´€ê³„ì§€í–¥"],
  "percentile": 25
}
---
[ì˜ˆì‹œ 3: ì†Œì‹¬í•œ í˜„ì‹¤ë„í”¼ ìœ í˜• (Common)]
{
  "type": "ğŸ’» ì¸í„°ë„· ìµìŠ¤í”Œë¡œëŸ¬",
  "summary": "ìœ„ê¸° ìƒí™©ì´ ë‹¥ì¹˜ì, í˜„ì‹¤ì˜ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸°ë³´ë‹¤ëŠ” ìµìˆ™í•˜ê³  ì•ˆì „í•œ ê°€ìƒ ì„¸ê³„ë¡œ ë„í”¼í•˜ëŠ”êµ°ìš”. ëª¨ë“  ê²Œ ëë‚˜ë©´ ê´œì°®ì•„ì§ˆ ê±°ë¼ê³  ë¯¿ê³  ì‹¶ì–´ í•©ë‹ˆë‹¤.",
  "advice": "ê°€ë”ì€ ë¡œê·¸ì•„ì›ƒí•˜ê³  ì°½ë°–ì„ ë³´ì„¸ìš”. ë¬¼ë¡  ì§€ê¸ˆì€ ë³´ë©´ ì•ˆ ë©ë‹ˆë‹¤.",
  "quote": "ì¼ë‹¨... F5(ìƒˆë¡œê³ ì¹¨) í•œë²ˆ ëˆŒëŸ¬ë³´ì.",
  "badge": "í˜„ì‹¤ë„í”¼ì",
  "rarity": "Common",
  "tags": ["íšŒí”¼í˜•", "ì•ˆì „ì§€í–¥", "ë‚´í–¥ì "],
  "percentile": 85
}
---
[ì‹¤ì œ ë¶„ì„ ìš”ì²­]
${formattedHistory}
`;

  try {
    const result = await model.generateContent(prompt);
    const text = result.response.text().replace(/```json|```/g, '').trim();
    const data = JSON.parse(text);
    return NextResponse.json(data);
  } catch (e) {
    console.error("AI ì‘ë‹µ ì²˜ë¦¬ ì‹¤íŒ¨:", e);
    // AIê°€ ìœ íš¨í•œ JSONì„ ìƒì„±í•˜ì§€ ëª»í–ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ê¸°ë³¸ê°’
    return NextResponse.json({
        type: "ğŸŒ€ ì˜ˆì¸¡ë¶ˆê°€ í˜¼ëˆí˜•",
        summary: "ë‹¹ì‹ ì˜ ì„ íƒì€ AIë§ˆì € í˜¼ë€ì— ë¹ ëœ¨ë ¸ìŠµë‹ˆë‹¤! ê¸°ì¡´ì˜ ìœ í˜•ìœ¼ë¡œëŠ” ë„ì €íˆ ë¶„ì„í•  ìˆ˜ ì—†ëŠ” ë¯¸ì§€ì˜ ì¡´ì¬ì…ë‹ˆë‹¤.",
        advice: "ê°€ë”ì€ ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì„ íƒì„ í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”? ë¬¼ë¡ , ê·¸ëŸ´ ë¦¬ ì—†ê² ì§€ë§Œìš”.",
        quote: "ë¶„ì„? ê·¸ê²Œ ë­”ë°. ë‚œ ë‚´ ê¸¸ì„ ê°„ë‹¤.",
        badge: "ë¯¸ì§€ì˜ ì¡´ì¬",
        rarity: "Epic",
        tags: ["í˜¼ëˆ", "ì˜ˆì¸¡ë¶ˆê°€", "ìœ ë‹ˆí¬"],
        percentile: 10
    }, { status: 500 });
  }
}
